了解です。Fastify/PostgreSQL 前提で、**予約・在庫・決済・通知・同意・運用**まで含む“実運用レベル”のDDLをまとめました。
（PostgreSQL 16 以降、UTC保存・`timestamptz`、`GENERATED BY DEFAULT AS IDENTITY` 採用）

> 設計ポイント
>
> * **在庫（timeslots）は「リソース単位」**で持ち、サービスは予約側（bookings）に紐付けます。
>   こうすると「同じスタッフに別サービスでダブルブッキング」が**構造的に起きません**（*スロットは資源の占有*）。
> * 検索APIは「サービスID」を受け取り、**該当サービスを提供可能なリソース×連続スロット**を返す設計にします（DBはリソース在庫のみを厳密管理）。
> * 主要クエリ用の**現実的なインデックス**／**監査**／**冪等**／**Webhook**／**Outbox**を網羅。

---

```sql
-- =========================================================
-- Reservation System DDL (PostgreSQL 16+)
-- =========================================================

-- 推奨拡張
CREATE EXTENSION IF NOT EXISTS pgcrypto;     -- gen_random_uuid()
CREATE EXTENSION IF NOT EXISTS citext;       -- case-insensitive text for emails etc.

-- タイムスタンプ自動更新トリガ
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
  NEW.updated_at := NOW();
  RETURN NEW;
END; $$;

-- =========================================================
-- 1) テナント & 設定
-- =========================================================
CREATE TABLE tenants (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  code          TEXT UNIQUE NOT NULL,
  name          TEXT NOT NULL,
  tz            TEXT NOT NULL DEFAULT 'Asia/Tokyo',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TRIGGER trg_tenants_updated_at
BEFORE UPDATE ON tenants FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE tenant_settings (
  tenant_id           BIGINT PRIMARY KEY REFERENCES tenants(id) ON DELETE CASCADE,
  currency_code       TEXT NOT NULL DEFAULT 'JPY',
  cancel_cutoff_min   INT  NOT NULL DEFAULT 1440,  -- オンライン取消期限（分）
  noshow_grace_min    INT  NOT NULL DEFAULT 15,    -- ノーショー猶予（分）
  reminder_1_min      INT  NOT NULL DEFAULT 1440,  -- 前日
  reminder_2_min      INT  NOT NULL DEFAULT 120,   -- 直前
  granularity_min     INT  NOT NULL DEFAULT 15,    -- スロット粒度
  allow_public_booking BOOLEAN NOT NULL DEFAULT TRUE,
  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TRIGGER trg_tenant_settings_updated_at
BEFORE UPDATE ON tenant_settings FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================================================
-- 2) ユーザー/RBAC（管理用）
-- =========================================================
CREATE TABLE users (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  email         CITEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  name          TEXT NOT NULL,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TRIGGER trg_users_updated_at
BEFORE UPDATE ON users FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 多テナントロール
CREATE TABLE user_tenant_roles (
  id         BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id    BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  tenant_id  BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  role       TEXT   NOT NULL CHECK (role IN ('owner','manager','staff','viewer','support')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(user_id, tenant_id)
);

-- =========================================================
-- 3) 顧客/同意
-- =========================================================
CREATE TABLE customers (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id     BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  name          TEXT   NOT NULL,
  phone         TEXT,
  email         CITEXT,
  line_user_id  TEXT,
  note          TEXT NOT NULL DEFAULT '',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, email),
  UNIQUE (tenant_id, phone)
);
CREATE INDEX idx_customers_tenant_created ON customers(tenant_id, created_at DESC);
CREATE TRIGGER trg_customers_updated_at
BEFORE UPDATE ON customers FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 規約同意（ノーショー課金の法務根拠）
CREATE TABLE consents (
  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id       BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  customer_id     BIGINT NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  version         TEXT NOT NULL,
  text_sha256     TEXT NOT NULL,                     -- 同意文のハッシュ
  accepted_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  accept_ip       INET,
  UNIQUE (tenant_id, customer_id, version)
);

-- =========================================================
-- 4) サービス/リソース/稼働カレンダ
-- =========================================================
CREATE TABLE services (
  id                 BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id          BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  name               TEXT   NOT NULL,
  description        TEXT   NOT NULL DEFAULT '',
  duration_min       INT    NOT NULL CHECK (duration_min > 0),
  price_jpy          INT    NOT NULL CHECK (price_jpy >= 0),
  buffer_before_min  INT    NOT NULL DEFAULT 0 CHECK (buffer_before_min >= 0),
  buffer_after_min   INT    NOT NULL DEFAULT 0 CHECK (buffer_after_min >= 0),
  active             BOOLEAN NOT NULL DEFAULT TRUE,
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_services_tenant_active ON services(tenant_id, active);
CREATE TRIGGER trg_services_updated_at
BEFORE UPDATE ON services FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- リソース（スタッフ/席/部屋/テーブル）
CREATE TABLE resources (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id     BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  kind          TEXT   NOT NULL CHECK (kind IN ('staff','seat','room','table')),
  name          TEXT   NOT NULL,
  capacity      INT    NOT NULL DEFAULT 1 CHECK (capacity >= 1),
  active        BOOLEAN NOT NULL DEFAULT TRUE,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_resources_tenant_kind ON resources(tenant_id, kind, active);
CREATE TRIGGER trg_resources_updated_at
BEFORE UPDATE ON resources FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- サービス提供可能リソース（適合表）
CREATE TABLE service_resources (
  id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id    BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  service_id   BIGINT NOT NULL REFERENCES services(id) ON DELETE CASCADE,
  resource_id  BIGINT NOT NULL REFERENCES resources(id) ON DELETE CASCADE,
  active       BOOLEAN NOT NULL DEFAULT TRUE,
  UNIQUE(tenant_id, service_id, resource_id)
);
CREATE INDEX idx_srv_res_tenant_service ON service_resources(tenant_id, service_id, active);

-- リソースグループ（任意：部屋/席カテゴリなど）
CREATE TABLE resource_groups (
  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id   BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  name        TEXT NOT NULL,
  kind        TEXT NOT NULL DEFAULT 'generic',
  created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE TABLE resource_group_members (
  id               BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  group_id         BIGINT NOT NULL REFERENCES resource_groups(id) ON DELETE CASCADE,
  resource_id      BIGINT NOT NULL REFERENCES resources(id) ON DELETE CASCADE,
  UNIQUE(group_id, resource_id)
);

-- 営業時間（テナント or リソース単位）
CREATE TABLE business_hours (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id     BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  resource_id   BIGINT REFERENCES resources(id) ON DELETE CASCADE, -- NULLなら全体
  day_of_week   SMALLINT NOT NULL CHECK (day_of_week BETWEEN 0 AND 6), -- 0=Sun
  open_time     TIME NOT NULL,
  close_time    TIME NOT NULL,
  effective_from DATE,
  effective_to   DATE,
  CHECK (open_time < close_time)
);
CREATE INDEX idx_bhours_tenant_resource ON business_hours(tenant_id, resource_id, day_of_week);

-- 休業日（テナント or リソース）
CREATE TABLE holidays (
  id          BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id   BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  resource_id BIGINT REFERENCES resources(id) ON DELETE CASCADE,
  date        DATE NOT NULL,
  name        TEXT NOT NULL DEFAULT '',
  UNIQUE (tenant_id, resource_id, date)
);

-- リソースの個別休暇/停止
CREATE TABLE resource_time_offs (
  id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id    BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  resource_id  BIGINT NOT NULL REFERENCES resources(id) ON DELETE CASCADE,
  start_at     TIMESTAMPTZ NOT NULL,
  end_at       TIMESTAMPTZ NOT NULL,
  reason       TEXT NOT NULL DEFAULT '',
  CHECK (start_at < end_at)
);
CREATE INDEX idx_timeoffs_res_time ON resource_time_offs(tenant_id, resource_id, start_at, end_at);

-- =========================================================
-- 5) 在庫（スロット：リソース単位）
-- =========================================================
CREATE TABLE timeslots (
  id                  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id           BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  resource_id         BIGINT NOT NULL REFERENCES resources(id) ON DELETE CASCADE,
  start_at            TIMESTAMPTZ NOT NULL,
  end_at              TIMESTAMPTZ NOT NULL,
  available_capacity  INT NOT NULL CHECK (available_capacity >= 0),
  created_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at          TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, resource_id, start_at, end_at),
  CHECK (start_at < end_at)
);
CREATE INDEX idx_timeslots_search ON timeslots(tenant_id, resource_id, start_at);
CREATE INDEX idx_timeslots_available ON timeslots(tenant_id, start_at, available_capacity);
CREATE TRIGGER trg_timeslots_updated_at
BEFORE UPDATE ON timeslots FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- （任意）capacity超過防止の安全弁トリガ（必要なら有効化）
-- リソース.capacity を超える available_capacity を禁止
CREATE OR REPLACE FUNCTION enforce_timeslot_capacity()
RETURNS trigger LANGUAGE plpgsql AS $$
DECLARE res_cap INT;
BEGIN
  SELECT capacity INTO res_cap FROM resources WHERE id = NEW.resource_id;
  IF NEW.available_capacity > res_cap THEN
    RAISE EXCEPTION 'available_capacity(%) exceeds resource capacity(%)', NEW.available_capacity, res_cap
      USING ERRCODE = '23514';
  END IF;
  RETURN NEW;
END; $$;
CREATE TRIGGER trg_timeslots_capacity
BEFORE INSERT OR UPDATE ON timeslots
FOR EACH ROW EXECUTE FUNCTION enforce_timeslot_capacity();

-- =========================================================
-- 6) 予約（ブッキング）
-- =========================================================
CREATE TABLE bookings (
  id                 BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id          BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  customer_id        BIGINT NOT NULL REFERENCES customers(id) ON DELETE RESTRICT,
  service_id         BIGINT NOT NULL REFERENCES services(id) ON DELETE RESTRICT,
  start_at           TIMESTAMPTZ NOT NULL,
  end_at             TIMESTAMPTZ NOT NULL,
  status             TEXT NOT NULL CHECK (status IN ('tentative','confirmed','cancelled','noshow','completed')),
  total_jpy          INT  NOT NULL CHECK (total_jpy >= 0),
  max_penalty_jpy    INT  NOT NULL DEFAULT 0 CHECK (max_penalty_jpy >= 0),
  idempotency_key    TEXT NOT NULL,
  created_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at         TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (tenant_id, idempotency_key),
  CHECK (start_at < end_at)
);
CREATE INDEX idx_bookings_tenant_time ON bookings(tenant_id, start_at);
CREATE INDEX idx_bookings_status ON bookings(tenant_id, status, start_at);
CREATE TRIGGER trg_bookings_updated_at
BEFORE UPDATE ON bookings FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 予約が確保した在庫明細（複合資源対応）
CREATE TABLE booking_items (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  booking_id    BIGINT NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
  timeslot_id   BIGINT NOT NULL REFERENCES timeslots(id) ON DELETE RESTRICT,
  resource_id   BIGINT NOT NULL REFERENCES resources(id) ON DELETE RESTRICT,
  UNIQUE (booking_id, timeslot_id, resource_id)
);
CREATE INDEX idx_bitems_booking ON booking_items(booking_id);
CREATE INDEX idx_bitems_timeslot ON booking_items(timeslot_id);

-- =========================================================
-- 7) 決済（Stripe想定）
-- =========================================================
-- 顧客の支払方法（SetupIntentで保存）
CREATE TABLE payment_methods (
  id                     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id              BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  customer_id            BIGINT NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
  provider               TEXT   NOT NULL DEFAULT 'stripe',
  provider_customer_id   TEXT,                -- e.g., cus_xxx
  provider_pm_id         TEXT,                -- e.g., pm_xxx
  is_default             BOOLEAN NOT NULL DEFAULT FALSE,
  created_at             TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(provider, provider_pm_id)
);
CREATE INDEX idx_pm_tenant_customer ON payment_methods(tenant_id, customer_id, is_default);

-- 予約に紐づく支払（デポジット/本体/違約金/返金）
CREATE TABLE payments (
  id                       BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id                BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  booking_id               BIGINT REFERENCES bookings(id) ON DELETE SET NULL,
  kind                     TEXT NOT NULL CHECK (kind IN ('deposit','charge','penalty','refund')),
  amount_jpy               INT  NOT NULL CHECK (amount_jpy >= 0),
  currency                 TEXT NOT NULL DEFAULT 'JPY',
  status                   TEXT NOT NULL CHECK (status IN ('requires_action','succeeded','failed','refunded','canceled','pending')),
  provider                 TEXT NOT NULL DEFAULT 'stripe',
  provider_payment_intent_id TEXT,           -- pi_xxx
  provider_charge_id       TEXT,
  failure_code             TEXT,
  failure_message          TEXT,
  created_at               TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at               TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(provider, provider_payment_intent_id)
);
CREATE INDEX idx_payments_booking ON payments(tenant_id, booking_id, status);
CREATE TRIGGER trg_payments_updated_at
BEFORE UPDATE ON payments FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- 受信Webhook（冪等）
CREATE TABLE webhook_events (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  provider       TEXT NOT NULL DEFAULT 'stripe',
  event_id       TEXT NOT NULL,      -- evt_xxx
  received_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  payload        JSONB NOT NULL,
  handled_at     TIMESTAMPTZ,
  status         TEXT NOT NULL DEFAULT 'received', -- received|processed|failed|ignored
  error_message  TEXT,
  UNIQUE(provider, event_id)
);

-- =========================================================
-- 8) 通知・Outbox・監査
-- =========================================================
CREATE TABLE notifications (
  id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id    BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  booking_id   BIGINT REFERENCES bookings(id) ON DELETE SET NULL,
  channel      TEXT NOT NULL CHECK (channel IN ('line','email','sms')),
  template     TEXT NOT NULL,               -- reminder_1day 等
  to_address   TEXT,                        -- email/phone
  to_line_user TEXT,                        -- LINE宛先
  payload      JSONB NOT NULL DEFAULT '{}'::jsonb,
  status       TEXT NOT NULL DEFAULT 'queued', -- queued|sent|failed
  send_at      TIMESTAMPTZ,                 -- 予定時刻
  error_message TEXT,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
CREATE INDEX idx_notifications_queue ON notifications(tenant_id, status, send_at);
CREATE TRIGGER trg_notifications_updated_at
BEFORE UPDATE ON notifications FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- トランザクショナル・アウトボックス（内部イベント）
CREATE TABLE outbox_events (
  id             BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id      BIGINT REFERENCES tenants(id) ON DELETE CASCADE,
  event_type     TEXT NOT NULL,            -- booking.created 等
  payload        JSONB NOT NULL,
  created_at     TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  next_attempt_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  attempts       INT NOT NULL DEFAULT 0,
  status         TEXT NOT NULL DEFAULT 'pending'  -- pending|sent|failed|dead
);
CREATE INDEX idx_outbox_dispatch ON outbox_events(status, next_attempt_at);

-- 監査ログ（PIIはアプリ側でマスク）
CREATE TABLE audit_logs (
  id           BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id    BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  actor_user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
  action       TEXT NOT NULL CHECK (action IN ('create','update','delete')),
  table_name   TEXT NOT NULL,
  record_id    BIGINT NOT NULL,
  before_data  JSONB,
  after_data   JSONB,
  created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =========================================================
-- 9) 冪等キー（POST /public/bookings 用）
-- =========================================================
CREATE TABLE idempotency_keys (
  id              BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tenant_id       BIGINT NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
  key             TEXT  NOT NULL,
  request_sha256  TEXT  NOT NULL,          -- リクエスト本文のハッシュ
  response_body   JSONB,                   -- 201/409等の直前応答を保存
  status          TEXT  NOT NULL DEFAULT 'in_progress', -- in_progress|completed|failed
  created_at      TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  expires_at      TIMESTAMPTZ NOT NULL,    -- TTL（例：作成後15分）
  UNIQUE(tenant_id, key)
);
CREATE INDEX idx_idem_expiry ON idempotency_keys(expires_at);

-- =========================================================
-- 10) 取消理由等（オプション辞書）
-- =========================================================
CREATE TABLE cancel_reasons (
  code        TEXT PRIMARY KEY,            -- e.g., customer_request, weather, overbook_fix
  label       TEXT NOT NULL
);

-- 予約取消の履歴（ステータス遷移ログ的に使う場合）
CREATE TABLE booking_cancellations (
  id            BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  booking_id    BIGINT NOT NULL REFERENCES bookings(id) ON DELETE CASCADE,
  reason_code   TEXT REFERENCES cancel_reasons(code) ON DELETE SET NULL,
  note          TEXT NOT NULL DEFAULT '',
  cancelled_by  TEXT NOT NULL DEFAULT 'customer', -- customer|staff|system
  created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =========================================================
-- 推奨ビュー（可用性返却などで使う補助）
-- =========================================================
-- 例）直近の空きスロット（可用性>0）
CREATE OR REPLACE VIEW v_available_timeslots AS
SELECT
  t.id           AS timeslot_id,
  t.tenant_id,
  t.resource_id,
  t.start_at,
  t.end_at,
  t.available_capacity
FROM timeslots t
WHERE t.available_capacity > 0;
```

---

## 運用メモ（重要ポイントだけ）

* **在庫更新**はアプリ側のトランザクションで実施：

  ```sql
  UPDATE timeslots
     SET available_capacity = available_capacity - 1
   WHERE id = $1 AND tenant_id = $2 AND available_capacity > 0
   RETURNING id;
  ```

  返らなければ `409 timeslot_sold_out`。

* **複合資源**（スタッフ＋部屋など）は、対象 `timeslot_id` 群を**同一順序で `SELECT ... FOR UPDATE`** → 全て `available_capacity > 0` 確認 → **全て減算** → `booking_items` 挿入 → コミット。

* **サービス適合**は `service_resources` で管理。APIの空き照会は

  1. テナント設定の `granularity_min` に従って、
  2. `services.duration_min + buffers` を満たす**連続スロット**を `timeslots` から探索、
  3. そのスロットが `service_resources.active=TRUE` の `resource_id` であることを条件に絞り込みます。

* **Stripe**：`payment_methods` に SetupIntent 成功結果を格納。違約金は `payments.kind='penalty'` で `off_session` 決済。Webhook は `webhook_events` で冪等化。

* **ETL/監査**：`audit_logs` は重要変更（bookings/payments 等）で before/after をアプリから書き込み。必要に応じてテーブルごとの監査トリガを追加してください。

---

このDDLで、前回のAPI仕様（REST/フラット返却/Idempotency/ダブルブッキング防止/ノーショー課金）を**そのまま実装**できます。
必要なら **マイグレーション雛形（node-pg-migrate/Prisma/Drizzle）** 版や、スロット生成用の**SQL/関数**もすぐ出します。
